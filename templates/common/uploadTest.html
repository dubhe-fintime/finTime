<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ë‹¤ìš´ë¡œë“œ</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        #upload-form { margin: 20px auto; width: 300px; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
        #preview { margin-top: 10px; max-width: 100%; height: auto; display: none; }
        #file-list { margin-top: 20px; text-align: left; display: inline-block; }
        .file-item { cursor: pointer; color: blue; text-decoration: underline; margin: 5px 0; }
        .delete-btn { color: red; cursor: pointer; font-size: 12px; }
    </style>
</head>
<body>

    <h2>ì´ë¯¸ì§€ íŒŒì¼ ì—…ë¡œë“œ</h2>
    
    <form id="upload-form">
        <input type="file" id="file-input" accept="image/*" required>
        <button type="submit">ì—…ë¡œë“œ</button>
    </form>

    <p id="message"></p>
    <img id="preview" src="" alt="ë¯¸ë¦¬ë³´ê¸°">

    <h3>ğŸ“‚ ì—…ë¡œë“œëœ íŒŒì¼ ëª©ë¡</h3>
    <div id="file-list"></div>

    <script>
        // íŒŒì¼ ì—…ë¡œë“œ & ë¯¸ë¦¬ë³´ê¸°
        document.getElementById('upload-form').addEventListener('submit', function(event) {
            event.preventDefault();

            let fileInput = document.getElementById('file-input');
            let file = fileInput.files[0];

            if (!file) {
                alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
                return;
            }

            let formData = new FormData();
            formData.append("file", file);

            fetch('/upload', {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                let message = document.getElementById('message');
                if (data.error) {
                    message.innerText = "âŒ " + data.error;
                    message.style.color = "red";
                } else {
                    message.innerText = "âœ… ì—…ë¡œë“œ ì„±ê³µ! íŒŒì¼ëª…: " + data.filename;
                    message.style.color = "green";

                    // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
                    let preview = document.getElementById('preview');
                    preview.src = "/resources/" + data.filename;
                    preview.style.display = "block";

                    loadFileList(); // ì—…ë¡œë“œ í›„ íŒŒì¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
        });

        // íŒŒì¼ ëª©ë¡ (ê²½ë¡œì—ì„œ ëª¨ë“  íŒŒì¼ëª… ê°€ì ¸ì˜¤ëŠ” í˜•ì‹(ì„ì‹œ))
        function loadFileList() {
            fetch('/files')
            .then(response => response.json())
            .then(data => {
                let fileListDiv = document.getElementById('file-list');
                fileListDiv.innerHTML = "";
                //console.log(data);
                data.forEach(function(v, i) {
                    let fileItem = document.createElement('div');
                    fileItem.className = "file-item";
                    fileItem.innerText = v.org_file_name;

                    // íŒŒì¼ì„ í´ë¦­í•˜ë©´ ë‹¤ìš´ë¡œë“œ
                    fileItem.onclick = () => downloadFile(v.file_name);

                    // ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
                    let deleteBtn = document.createElement('span');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.innerText = 'ì‚­ì œ';
                    deleteBtn.onclick = (event) => {
                        event.stopPropagation(); // í´ë¦­ì´ ë¶€ëª¨ ìš”ì†Œë¡œ ì „íŒŒë˜ì§€ ì•Šê²Œ í•¨
                        deleteFile(v.file_name);
                    };

                    fileItem.appendChild(deleteBtn);
                    fileListDiv.appendChild(fileItem);
                });

               
            })
            .catch(error => console.error("íŒŒì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error));
        }

        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        function downloadFile(filename) {
            let formData = new FormData();
            formData.append("file_name", filename);

            fetch("/fileDownload", {
                    method: "POST",
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨");
                    }
                    return response.blob();
                })
                .then(blob => {
                    let url = window.URL.createObjectURL(blob);
                    let a = document.createElement("a");
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                });
        }

        // íŒŒì¼ ì‚­ì œ
        function deleteFile(filename) {
            let formData = new FormData();
            formData.append("file_name", filename);

            fetch("/deleteFile", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("ì‚­ì œ ì‹¤íŒ¨: " + data.error);
                } else {
                    alert(data.message);
                    loadFileList(); // ì‚­ì œ í›„ íŒŒì¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ íŒŒì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        loadFileList();
    </script>

</body>
</html>
